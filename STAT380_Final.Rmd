---
title: "Analysis of factors influencing suicide rate"
output: html_document
---

# Part 1: Data Preparation

The missing rate of  HDI.for.year in master.CSV is 69.93%, so delete this variable and select the data from 1996 to 2016 for analysis. In the Economic data, four indicators, namely "Services, value added (% of GDP)", "Industry (including construction), value added (% of GDP)", "Manufacturing, value added (% of GDP)", "Agriculture, forestry, and fishing, value added (% of GDP), were selected to analyze their impact on suicide rate.

```{r,warning=F}
#my file location: C:\Users\a5730\OneDrive\Documents\STAT380\Stat380Final_Chan_Tang
setwd("C:\\users\\a5730\\OneDrive\\Documents\\STAT380\\Stat380Final_Chan_Tang")
master <- read.csv("master.csv", header = T, sep = ",", stringsAsFactors = F)
Economic <- read.csv("API_3_DS2_en_csv_v2_10523844.csv", header = T, sep = ",", stringsAsFactors = F)

# missing rate
colSums(is.na(master))/nrow(master)
# delete HDI.for.year and country.year
master <- master[which(master$year>1996 & master$year<2017),-c(8,9)]

# Economic data processing
fun1 <- function(x){
  data <- Economic[which(Economic$Indicator.Code==x),c(1,4,41:61)]
  data2 <- data[,c(1,3)]
  data2$year <- 1996
  colnames(data2) <- c("country",x,"year")
  j=1
  for(i in 4:23){
    data1 <- data[,c(1,i)]
    data1$year <- 1996+j
    colnames(data1) <- c("country",x,"year")
    data2 <- rbind(data2,data1)
    j=j+1
  }
  return(data2)
}

value <- c("NV.SRV.TOTL.ZS","NV.IND.TOTL.ZS","NV.IND.MANF.ZS","NV.AGR.TOTL.ZS")
Economic_Services <- fun1(value[1])
Economic_Industry <- fun1(value[2])
Economic_Manufacturing <- fun1(value[3])
Economic_Agriculture <- fun1(value[4])
Economic2 <- merge(Economic_Services, Economic_Industry, all = T, by=c("country","year"))
Economic2 <- merge(Economic2, Economic_Manufacturing, all = T, by=c("country","year"))
Economic2 <- merge(Economic2, Economic_Agriculture, all = T, by=c("country","year"))

# merge master and Economic2
master <- merge(master,Economic2,all.x = T,by=c("country","year"))
# missing rate
colSums(is.na(master))/nrow(master)
# delete missing data
master <- na.omit(master)
# save
write.csv(master,"master_new.csv",row.names = F)
```

# Part 2: Data Wrangling

## A. General purpose data wrangling

```{r,warning=F}
master <- read.csv("master_new.csv",stringsAsFactors = F)
# summarise and group_by
library(dplyr)
# Annual statistics on suicide rates and suicides
head(summarise(group_by(master,year),
                   max_suicides.100k.pop = max(suicides.100k.pop),
                   avg_suicides_no = mean(suicides_no),    
                   sum_suicides_no = sum(suicides_no))) 
# Statistics on suicide rates and suicides per country per year
head(summarise(group_by(master,year,country),
                   avg_suicides_no = mean(suicides_no),    
                   sum_suicides_no = sum(suicides_no),
                   suicide_rates_100k = sum(suicides_no)/sum(population)*100000)) # suicide_rates*100000
# country 
print(distinct(master,country))
```

## B. Spread & gather to stack/unstack variables

```{r,warning=F}
# sex, suicides_no and population
data1 <- stack(master[,c(3,5,6)])
head(data1)
data2 <- unstack(data1,values~ind)
head(data2)
```

## C. User-defined functions

```{r,warning=F}
# Mode
fun2 <- function(x){
  t <- as.data.frame(table(x))
  t.max <- t[which(t[,2]==max(t[,2])),1]
  return(t.max)
} 
# The mode of suicides_no
fun2(master$suicides_no)
```

## D. loops and/or control flow

Calculate suicide rate for people over 35 years old and under 35 years old.It was found that the suicide rate of people over 35 years old was significantly higher than that of people under 35 years old.

```{r,warning=F}
age <- NA
for(i in 1:nrow(master)){
  if(master$age[i] %in% c("5-14 years","15-24 years","25-34 years")){
    age[i] <- 0
  }else{
    age[i] <- 1
  }
}
age <- cbind(master[,c(5,6)],age)
# Suicide rate less than 35 years old * 100K
sum(age[which(age$age==0),1])/sum(as.numeric(age[which(age$age==0),2]))*100000
# Suicide rate more than 35 years old * 100K
sum(age[which(age$age==1),1])/sum(as.numeric(age[which(age$age==1),2]))*100000
```

## E. Apply

```{r,warning=F}
# sapply  sex and suicides_no
sapply(unstack(master[,c(5,3)]),mean)
# apply 
apply(master[,c(5,6,7)],2,mean)
```


# Part 3: Data Visualization

```{r,warning=F}
library(ggplot2)
# suicides_no and population
ggplot(master, aes(x=population, y=suicides_no, colour=suicides.100k.pop)) +
  geom_point() +
  labs(title="Scatter plot of suicides_no and population") 
```

Scatter plots of numerical variables and suicides.100k.pop

```{r,warning=F}
library(ggpubr)
# population
p1 <- ggplot(master, aes(x=population, y=suicides.100k.pop, colour=factor(sex))) +
  geom_point()
# gdp_for_year
p2<- ggplot(master, aes(x=gdp_for_year...., y=suicides.100k.pop, colour=factor(sex))) +
  geom_point()
# gdp_per_capita ($)
p3 <- ggplot(master, aes(x=gdp_per_capita...., y=suicides.100k.pop, colour=factor(sex))) +
  geom_point()
# NV.SRV.TOTL.ZS
p4 <- ggplot(master, aes(x=NV.SRV.TOTL.ZS, y=suicides.100k.pop, colour=factor(sex))) +
  geom_point()
# NV.IND.TOTL.ZS
p4 <- ggplot(master, aes(x=NV.IND.TOTL.ZS, y=suicides.100k.pop, colour=factor(sex))) +
  geom_point()
# NV.IND.MANF.ZS
p5 <- ggplot(master, aes(x=NV.IND.MANF.ZS, y=suicides.100k.pop, colour=factor(sex))) +
  geom_point()
# NV.AGR.TOTL.ZS
p6 <- ggplot(master, aes(x=NV.AGR.TOTL.ZS, y=suicides.100k.pop, colour=factor(sex))) +
  geom_point()
ggarrange(p1,p2,p3,p4,p5,p6,ncol=2,nrow=3)
```

Bar plot of categorical variables

```{r,warning=F}
ggplot(master,aes(country))+geom_bar(position="dodge")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(master,aes(age))+geom_bar(position="dodge")
ggplot(master,aes(sex))+geom_bar(position="dodge")
ggplot(master,aes(generation))+geom_bar(position="dodge")
```

Boxplot plot of categorical variables and suicides.100k.pop

```{r,warning=F}
p1 <- ggplot(master,aes(x=sex,y=suicides.100k.pop,group=sex))+
  geom_boxplot()
p2 <- ggplot(master,aes(x=age,y=suicides.100k.pop,group=age))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
p3 <- ggplot(master,aes(x=generation,y=suicides.100k.pop,group=generation))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggarrange(p1,p2,p3,ncol=3,nrow=1)
ggplot(master,aes(x=country,y=suicides.100k.pop,group=country))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Plot of the correlation coefficient of numerical variables

```{r,warning=F}
library(tidyr)
corr <- cor(master[,-c(1,2,3,4,10)])
cor_dia_df <- as.data.frame(corr) %>%
  mutate(var1=row.names(corr))%>%
  gather(suicides_no:NV.AGR.TOTL.ZS,key=var2,value=correlation)
ggplot(cor_dia_df)+
  geom_tile(aes(var1,var2,fill=correlation))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_fill_gradient2()
```

# Part 4: Data Analysis

## 4.1 Cluster analysis

First of all, the classification of variables as dummy variables. Secondly, standardization of data.

```{r,warning=F}
# dummy variables
sex <- as.data.frame(model.matrix(~sex,master))
age <- as.data.frame(model.matrix(~age,master))
generation <- as.data.frame(model.matrix(~generation, master))
master2 <- cbind(master,age[,-1],sex[,-1],generation[,-1])
master2 <- master2[,-c(3,4,10)]
# standardization
master_scale <- scale(master2[,-c(1,2,3,5)])
master_scale <- as.data.frame(master_scale)
```

K-means

```{r,warning=F}
# Determining the Best Cluster Number
wss<-numeric(15)
for (k in 1:15){
   wss[k]<-sum(kmeans(master_scale,centers = k,nstart = 10)$withinss)
}
plot(1:15,wss,type = "b",xlab = "x",ylab = "y")

# K-means (k=4)
km <- kmeans(master_scale,4)
suicides <- as.data.frame(cbind(master$suicides.100k.pop,km$cluster))
boxplot(suicides$V1~suicides$V2,xlab="cluster",ylab="suicides.100k.pop")
```

## 4.2 Multiple regression analysis

Data from 1997 to 2013 for training and data from 2014 to 2016 for testing.The rmse of multiple linear regression is 3.761684, and the RMSE of decision tree is 3.23228. The prediction of decision tree is more accurate.

```{r,warning=F}
traindata <- master[-which(master$year>2013),-5]
testdata <- master[which(master$year>2013),-5]
# model
fit_lm <- lm(suicides.100k.pop~.,data=traindata[,-c(1,2)])
summary(fit_lm)
# Regression diagnosis
par(mfrow=c(2,2))
plot(fit_lm)
# predict
lm_pre <- predict(fit_lm,testdata)
rmse <- (sum((testdata$suicides.100k.pop-lm_pre)^2)/nrow(master))^0.5
rmse
```

## 4.3 Decision Tree

```{r,warning=F}
library(rpart)
library(rpart.plot)
fit_tree <- rpart(suicides.100k.pop~.,data=traindata[,-c(1,2)])
# Prune
plotcp(fit_tree)
fit_tree2 <-prune(fit_tree, cp= fit_tree$cptable[which.min(fit_tree$cptable[,"xerror"]),"CP"]) 
rpart.plot(fit_tree2,branch=1, under=TRUE, faclen=0,roundint=F,
           cex=0.6, main="Decision Tree (pruned)")
# predict
tree_pre <- predict(fit_tree2,testdata)
rmse <- (sum((testdata$suicides.100k.pop-tree_pre)^2)/nrow(master))^0.5
rmse
```

