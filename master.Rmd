---
title: "Stat 380 Final Project"
output: html_document
---



```{r}
library(dplyr)
library(ggplot2)
library(ggpubr)
library(tidyr)
library(mosaic)
```

# Part 1: Data Preparation

The missing rate of  HDI.for.year in master.CSV is 69.93%, so delete this variable and select the data from 1996 to 2016 for analysis. In the Economic data, four indicators, namely "Services, value added (% of GDP)", "Industry (including construction), value added (% of GDP)", "Manufacturing, value added (% of GDP)", "Agriculture, forestry, and fishing, value added (% of GDP), were selected to analyze their impact on suicide rate.


```{r}
#Suicide rate Dataset
master <- read.csv("master.csv", 
                   header = T, 
                   sep = ",",
                   stringsAsFactors = F)
#Economic dataset
Economic <- read.csv("API_3_DS2_en_csv_v2_10523844.csv",
                     header = T, 
                     sep = ",", 
                     stringsAsFactors = F)
```

```{r}
# missing rate
colSums(is.na(master))/nrow(master)
# delete HDI.for.year and country.year
master <- master[which(master$year>1996 & master$year<2017),-c(8,9)]
```

```{r}
# Economic data processing
fun1 <- function(x){
  data <- Economic[which(Economic$Indicator.Code==x),c(1,4,41:61)]
  data2 <- data[,c(1,3)]
  data2$year <- 1996
  colnames(data2) <- c("country",x,"year")
  j=1
  for(i in 4:23){
    data1 <- data[,c(1,i)]
    data1$year <- 1996+j
    colnames(data1) <- c("country",x,"year")
    data2 <- rbind(data2,data1)
    j=j+1
  }
  return(data2)
}

value <- c("NV.SRV.TOTL.ZS","NV.IND.TOTL.ZS","NV.IND.MANF.ZS","NV.AGR.TOTL.ZS")
Economic_Services <- fun1(value[1])
Economic_Industry <- fun1(value[2])
Economic_Manufacturing <- fun1(value[3])
Economic_Agriculture <- fun1(value[4])

Economic2 <- merge(Economic_Services, Economic_Industry, 
                   all = T, 
                   by=c("country","year"))
Economic2 <- merge(Economic2, Economic_Manufacturing,
                   all = T, 
                   by=c("country","year"))
Economic2 <- merge(Economic2, Economic_Agriculture,
                   all = T,
                   by=c("country","year"))
```


```{r}
# merge master and Economic2
master <- merge(master, Economic2,
                all.x = T,
                by=c("country","year"))
# missing rate
colSums(is.na(master))/nrow(master)
# delete missing data
master <- na.omit(master)
```

# Part 2: Data Wrangling

## A. General purpose data wrangling

```{r,warning=F}

master <- read.csv("master_new.csv",stringsAsFactors = F)
```

```{r}
# summarise and group_by
# Annual statistics on suicide rates and suicides
head(summarise(group_by(master, year),
                   max_suicides.100k.pop = max(suicides.100k.pop),
                   avg_suicides_no = mean(suicides_no),    
                   sum_suicides_no = sum(suicides_no))) 

# Statistics on suicide rates and suicides per country per year
head(summarise(group_by(master, year, country),
                   avg_suicides_no = mean(suicides_no),    
                   sum_suicides_no = sum(suicides_no),
                   suicide_rates_100k = sum(suicides_no) / sum(population) * 100000)) # suicide_rates*100000
# country 
print(distinct(master, country))
```
## B. Spread & gather to stack/unstack variables

```{r,warning=F}
# sex, suicides_no and population
data1 <- stack(master[,c(3, 5, 6)])
head(data1)
data2 <- unstack(data1, values~ind)
head(data2)
```

## C. User-defined functions

```{r,warning=F}
# Mode
fun2 <- function(x){
  t <- as.data.frame(table(x))
  t.max <- t[which(t[,2] == max(t[,2])),1]
  return(t.max)
} 
# The mode of suicides_no
fun2(master$suicides_no)
```

## D. loops and/or control flow

Calculate suicide rate for people over 35 years old and under 35 years old.It was found that the suicide rate of people over 35 years old was significantly higher than that of people under 35 years old. The suicide rate for men over 35 was 16.72724 percent and the suicide rate for people under 35 was 7.34 percent.

```{r,warning=F}
age <- NA
for(i in 1:nrow(master)){
  if(master$age[i] %in% c("5-14 years", "15-24 years", "25-34 years")){
    age[i] <- 0
  }else{
    age[i] <- 1
  }
}
age <- cbind(master[,c(5,6)], age)
# Suicide rate less than 35 years old * 100K
sum(age[which(age$age==0), 1]) / sum(as.numeric(age[which(age$age == 0), 2])) * 100000
# Suicide rate more than 35 years old * 100K
sum(age[which(age$age == 1), 1]) / sum(as.numeric(age[which(age$age == 1), 2])) * 100000
```

## E. Apply

```{r,warning=F}
# sapply  sex and suicides_no
sapply(unstack(master[,c(5,3)]), mean)
# apply 
apply(master[,c(5, 6, 7)], 2, mean)
```


# Part 3: Data Visualization

```{r,warning=F}

# suicides_no and population
ggplot(master, aes(x = population, y = suicides_no, colour = suicides.100k.pop)) +
  geom_point() +
  labs(title = "Scatter plot of suicides_no and population") 
```


```{r}
# population
p1 <- ggplot(master, aes(x = population, y = suicides.100k.pop, colour = factor(sex))) +
  geom_point()
# gdp_for_year
p2<- ggplot(master, aes(x = gdp_for_year...., y = suicides.100k.pop, colour = factor(sex))) +
  geom_point()
# gdp_per_capita ($)
p3 <- ggplot(master, aes(x = gdp_per_capita...., y = suicides.100k.pop, colour = factor(sex))) +
  geom_point()
# NV.SRV.TOTL.ZS
p4 <- ggplot(master, aes(x = NV.SRV.TOTL.ZS, y = suicides.100k.pop, colour = factor(sex))) +
  geom_point()
# NV.IND.TOTL.ZS
p4 <- ggplot(master, aes(x = NV.IND.TOTL.ZS, y = suicides.100k.pop, colour = factor(sex))) +
  geom_point()
# NV.IND.MANF.ZS
p5 <- ggplot(master, aes(x = NV.IND.MANF.ZS, y = suicides.100k.pop, colour = factor(sex))) +
  geom_point()
# NV.AGR.TOTL.ZS
p6 <- ggplot(master, aes(x = NV.AGR.TOTL.ZS, y = suicides.100k.pop, colour = factor(sex))) +
  geom_point()

ggarrange(p1, p2, p3, p4, p5, p6, ncol = 2, nrow = 3)
```

```{r}
# Bar plot of categorical variables in the dataset
# count for countries
###FIXME: might need to adjust the size
ggplot(master,aes(country)) +
  geom_bar(position="dodge") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
# check counts for different age groups
ggplot(master, aes(age)) +
  geom_bar(position = "dodge") + ggtitle("Counts for different age groups")

```

```{r}
#for genders
ggplot(master, aes(sex)) +
  geom_bar(position = "dodge")
```

```{r}
#different generation groups graph
ggplot(master, aes(generation)) +
  geom_bar(position = "dodge")
```
```{r}
# Boxplot plot of categorical variables and suicides.100k.pop
p1 <- ggplot(master,
             aes(x = sex, y = suicides.100k.pop, group = sex)) +
  geom_boxplot()
p2 <- ggplot(master,aes(x = age, y = suicides.100k.pop, group = age)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
p3 <- ggplot(master, aes(x = generation, y = suicides.100k.pop, group = generation)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggarrange(p1, p2, p3, ncol = 3, nrow = 1)
```


# Part 4: Data Analysis
## 4.1 Cluster analysis
### First of all, the classification of variables as dummy variables. 
###Secondly, standardization of data.
```{r}
# dummy variables
sex <- as.data.frame(model.matrix(~sex,master))
age <- as.data.frame(model.matrix(~age,master))
generation <- as.data.frame(model.matrix(~generation, master))
master2 <- cbind(master,age[,-1],sex[,-1],generation[,-1])
master2 <- master2[,-c(3,4,10)]
```

```{r}
# standardization
master_scale <- scale(master2[,-c(1, 2, 3, 5)])
master_scale <- as.data.frame(master_scale)
```

### K-means data analysis
```{r}
# Determining the Best Cluster Number
wss<-numeric(15)
for (k in 1:15){
   wss[k] <- sum(kmeans(master_scale, centers = k, nstart = 10)$withinss)
}
plot(1:15, wss, 
     type = "b", 
     xlab = "x",
     ylab = "y")
```




```{r}
# K-means (k=3)
km <- kmeans(master_scale, 3)
suicides <- as.data.frame(cbind(master$suicides.100k.pop, km$cluster))
boxplot(suicides$V1~suicides$V2, 
        xlab="cluster", 
        ylab = "suicides.100k.pop")
```
```{r}
# K-means (k=4)
km <- kmeans(master_scale, 4)
suicides <- as.data.frame(cbind(master$suicides.100k.pop, km$cluster))
boxplot(suicides$V1~suicides$V2, 
        xlab="cluster", 
        ylab = "suicides.100k.pop")
```

```{r}
# K-means (k=5)
km <- kmeans(master_scale, 5)
suicides <- as.data.frame(cbind(master$suicides.100k.pop, km$cluster))
boxplot(suicides$V1~suicides$V2, 
        xlab="cluster", 
        ylab = "suicides.100k.pop")
```
```{r}
# K-means (k=8)
km <- kmeans(master_scale, 8)
suicides <- as.data.frame(cbind(master$suicides.100k.pop, km$cluster))
boxplot(suicides$V1~suicides$V2, 
        xlab="cluster", 
        ylab = "suicides.100k.pop")
```

# .2 Multiple regression analysis
### Data from 1997 to 2013 for training and data from 2014 to 2016 for testing.The rmse of multiple linear regression is 3.761684, and the RMSE of decision tree is 3.23228. The prediction of decision tree is more accurate.


```{r}
# train test split
traindata <- master[-which(master$year > 2013), -5]
testdata <- master[which(master$year > 2013), -5]
# fit lm
fit_lm <- lm(suicides.100k.pop~.,data = traindata[,-c(1, 2)])
summary(fit_lm)
```

```{r}
# Regression diagnosis
par(mfrow = c(2, 2))
plot(fit_lm)
```

```{r}
# predict on test dataset
lm_pre <- predict(fit_lm,testdata)
# Using RMSE as the evluation score
rmse <- (sum((testdata$suicides.100k.pop-lm_pre) ^ 2) / nrow(master)) ^ 0.5
rmse
```
###.3  Random Simulation

### Here are 500 simulations 
```{r}
trials_bootstrap <-
  mosaic::do(500) * 
  mean(~suicides_no, data = 
           sample_n(master, size = 200, replace = TRUE), na.rm = TRUE)
# 95% confidence interval for the median number of suicide rates 
confint(trials_bootstrap, level = 0.95)
```
 
